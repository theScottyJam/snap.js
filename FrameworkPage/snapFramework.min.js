export class Signal{#e;#t=new Set;constructor(e=void 0){this.#e=e}subscribe(e){console.assert(!this.#t.has(e)),this.#t.add(e)}unsubscribe(e){console.assert(this.#t.has(e)),this.#t.delete(e)}get(){return this.#e}set(e){if(this.#e!==e){this.#e=e;for(const t of this.#t)t(e)}}}export function useSignals(e,t){const n=new Signal(void 0),o=()=>{const o=t(...e.map((e=>e.get())));n.set(o)};for(const t of e)t.subscribe(o);return o(),useCleanup((()=>{for(const t of e)t.unsubscribe(o)})),n}export class Context{#n=[];provide(e,t){this.#n.push(e);try{return t()}finally{this.#n.pop()}}get(){return console.assert(this.#n.length>0,"Attempted to use a context object that does not have a value provided to it (via .provide())."),this.#n.at(-1)}}export function defineElement(e,t){return class n extends HTMLElement{api={};constructor(...e){super();this.attachShadow({mode:"closed"}).append(t.call(this,...e))}static{const t=String(Math.random()).slice(2,10);customElements.define(`${e.toLowerCase()}-${t}`,n)}}}const onUninitContext=new Context;export function withLifecycle(e){const t=new Signal(!1);return{uninit:()=>t.set(!0),value:onUninitContext.provide(t,e)}}export function useCleanup(e){onUninitContext.get().subscribe(e)}export function html(e,...t){const n=e=>null!==e&&Object.getPrototypeOf(e)===Function.prototype,o=e=>e instanceof HTMLElement||e instanceof DocumentFragment;let r=e[0];for(const[s,a]of e.slice(1).entries()){const e=t[s];if(n(e))r+=`data-frameworkref="${s}"`;else{if(!o(e))throw new Error("Invalid value interpolated into the html tag.");r+=`<template data-frameworkref="${s}" data-info="placeholder"></template>`}r+=a}const s=document.createElement("template");s.innerHTML=r.trim();for(const[e,r]of t.entries())if(n(r)){const t=s.content.querySelector(`*[data-frameworkref="${e}"]`);delete t.dataset.frameworkref,r(t)}else if(o(r)){const t=s.content.querySelector(`*[data-frameworkref="${e}"]`);t.parentNode.insertBefore(r,t),t.parentNode.removeChild(t)}return s.content}export const set=(e,t=void 0)=>n=>{for(const[t,o]of Object.entries(e)){useSignals([o instanceof Signal?o:new Signal(o)],(e=>{n[t]=e}))}return t?.(n),n};export function renderEach(e,t){let n=new Map;const o=document.createComment("start renderEach()"),r=document.createComment("end renderEach()"),s=document.createDocumentFragment();return s.append(o,r),useCleanup((()=>{for(const{uninit:e}of n.values())e()})),useSignals([e],(e=>{const s=document.createDocumentFragment();for(const[o,r]of e)if(n.has(o)){const{markStart:e,markEnd:t}=n.get(o),r=document.createRange();r.setStartBefore(e),r.setEndAfter(t),s.append(r.extractContents())}else{const e=document.createComment("start renderEach child"),a=document.createComment("end renderEach child"),c=()=>t(r,o),{uninit:i,value:l}=withLifecycle(c);s.append(e,l,a),n.set(o,{markStart:e,markEnd:a,uninit:i})}const a=new Set(e.map((([e])=>e)));for(const[e,{uninit:t}]of n)a.has(e)||(t(),n.delete(e));const c=document.createRange();c.setStartAfter(o),c.setEndBefore(r),c.deleteContents(),r.parentNode.insertBefore(s,r)})),s}export function renderChoice(e){return renderEach(useSignals(e.map((e=>e.signalWhen)),((...e)=>{const t=e.findIndex((e=>e));return-1===t?[]:[[t,t]]})),(t=>e[t].render()))}