class Context{#e=[];provide(e,t){this.#e.push(e);try{return t()}finally{this.#e.pop()}}get(){return this.#e.at(-1)}}const onUninitContext=new Context;export function withLifecycle(e){let t=[];return{uninit:()=>{for(const e of t)e();t=[]},value:onUninitContext.provide((e=>t.push(e)),e)}}export function useCleanup(e){const t=onUninitContext.get();if(void 0===t)throw new Error("useCleanup() must be called during the execution of a withLifecycle() callback.");t(e)}export class Signal{#t;#n=new Set;#o=()=>{};constructor(e=void 0){this.#t=e}get(){return this.#t}set(e){const t=new Set,n=new Set;for(;;){const o=new Map;{const e=[{signal:this,parent:void 0}];for(;e.length>0;){const{signal:t,parent:n}=e.pop();if(o.has(t))console.assert(void 0!==n),o.get(t).push(n);else{o.set(t,void 0!==n?[n]:[]);const r=[...t.#n].map((e=>({signal:e,parent:t})));e.push(...r)}}}const r=[];{const e=new Set(o.keys()),n=[this];let s=[];for(;n.length>0;){const a=n.pop();if(!e.has(a))continue;o.get(a).some((t=>e.has(t)))?s.unshift(a):(t.has(a)||r.push(a),e.delete(a),n.push(...[...a.#n].toReversed()),n.push(...s),s.length=[])}}if(0===r.length)break;for(const s of r){const r=o.get(s);if(r.length>0&&r.every((e=>n.has(e)))){t.add(s),n.add(s);continue}const a=s.#t;s===this?this.#t=e:s.#o(),t.add(s),a===s.#t&&n.add(s)}}}static use(e,t){const n=new Signal(void 0);let o=!1,r=()=>{};n.#o=()=>{if(o)return;r();const s=e.map((e=>e.#t)),a=withLifecycle((()=>t(...s)));n.#t=a.value,r=a.uninit},n.#o();for(const t of e)t.#n.add(n);return useCleanup((()=>{r();for(const t of e)t.#n.delete(n);o=!0})),n}use(e){return Signal.use([this],e)}}export function html(e,...t){const n=e=>null!==e&&Object.getPrototypeOf(e)===Function.prototype,o=e=>e instanceof HTMLElement||e instanceof DocumentFragment||e instanceof Text;let r=e[0];for(const[s,a]of e.slice(1).entries()){const e=t[s];if(n(e))r+=`data-frameworkref="${s}"`;else{if(!o(e))throw new Error("Invalid value interpolated into the html tag.");r+=`<template data-frameworkref="${s}"></template>`}r+=a}const s=document.createElement("template");s.innerHTML=r.trim();for(const[e,r]of t.entries())if(n(r)){const t=s.content.querySelector(`*[data-frameworkref="${e}"]`);delete t.dataset.frameworkref,r(t)}else if(o(r)){const t=s.content.querySelector(`*[data-frameworkref="${e}"]`);t.parentNode.insertBefore(r,t),t.parentNode.removeChild(t)}return s.content}export const set=(e,t=void 0)=>n=>{for(const[t,o]of Object.entries(e)){(o instanceof Signal?o:new Signal(o)).use((e=>{n[t]=e}))}return t?.(n),n};export function renderEach(e,t){let n=new Map;const o=document.createComment("start renderEach()"),r=document.createComment("end renderEach()"),s=document.createDocumentFragment();return s.append(o,r),useCleanup((()=>{for(const{uninit:e}of n.values())e()})),e.use((e=>{const s=document.createDocumentFragment();for(const[o,r]of e)if(n.has(o)){const{markStart:e,markEnd:t}=n.get(o),r=document.createRange();r.setStartBefore(e),r.setEndAfter(t),s.append(r.extractContents())}else{const e=document.createComment("start renderEach child"),a=document.createComment("end renderEach child"),c=()=>t(r,o),{uninit:i,value:l}=withLifecycle(c);s.append(e,l,a),n.set(o,{markStart:e,markEnd:a,uninit:i})}const a=new Set(e.map((([e])=>e)));for(const[e,{uninit:t}]of n)a.has(e)||(t(),n.delete(e));const c=document.createRange();c.setStartAfter(o),c.setEndBefore(r),c.deleteContents(),r.parentNode.insertBefore(s,r)})),s}export function renderChoice(e){return renderEach(Signal.use(e.map((e=>e.signalWhen)),((...e)=>{const t=e.findIndex((e=>e));return-1===t?[]:[[t,t]]})),(t=>e[t].render()))}export function defineElement(e,t){return class n extends HTMLElement{api={};constructor(...e){super();this.attachShadow({mode:"closed"}).append(t.call(this,...e))}static{const t=String(Math.random()).slice(2,10);customElements.define(`${e.toLowerCase()}-${t}`,n)}}}